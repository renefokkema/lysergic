
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<script type="text/javascript" charset="utf-8">


	var time_diffs = new Array();
	var diffs_total = 0;
	var best_diff;

		function init(count) {
		
			// Vraag een aantal keer server- en client-tijden op.
			for (i=0; i<count; i++)
			{
				
				setTimeout(getNow, (i+1)*500);
			}
			
			// Neem het gemiddelde van de verschillen.
			setTimeout(function() {
					best_diff = diffs_total/count;
					
					document.getElementById("demo").innerHTML += "Best mean difference: " + best_diff + "ms";
			}, count*500+1000);
			
			// Vraag nogmaals tijden op, en bereken telkens de meest nauwkeurig geschatte tijd van de server met het gemiddelde.
			setTimeout( function() {
			
			document.getElementById("demo").innerHTML = "SERVER\t\tCLIENT\t\tEST\n";
			
			for (i=0; i<count; i++)
			{
				setTimeout(getFinalNow, (i+1)*500);
			}
			}, count*500+5000);
		}
		
		function getNow() {
		
			var xhttp = new XMLHttpRequest();
			
			var req_start;
			
			
			xhttp.onreadystatechange=function() {
			    if (this.readyState == 4 && this.status == 200) {
			    
					var server_now = parseInt(this.responseText);
					var best_client_now = Date.now()-(Date.now()-req_start)/2;
					
					diffs_total += best_client_now-server_now;
					time_diffs[time_diffs.length] = best_client_now-server_now;
					
					document.getElementById("demo").innerHTML += server_now + "\t" + (Date.now()) + "\t\t" + (Date.now()-server_now) + "\n";
					document.getElementById("demo").innerHTML += server_now + "\t" + best_client_now + "\t\t" + (best_client_now-server_now) + "\n\n";
				}
			};
				
			xhttp.open("GET", "./now.php?t=" + Math.random(), true);
			req_start = Date.now();
			xhttp.send();
		}
		
		function getFinalNow() {
		
			var xhttp = new XMLHttpRequest();
			
			var req_start;

			
			xhttp.onreadystatechange=function() {
			    if (this.readyState == 4 && this.status == 200) {
			    
					var server_now = parseInt(this.responseText);
					var best_client_now = Date.now()-(Date.now()-req_start)/2;
					
					document.getElementById("demo").innerHTML += server_now + "\t" + Date.now() + "\t" + Math.round(best_client_now-best_diff) + "\n";
				}
			};
				
			xhttp.open("GET", "./now.php?t=" + Math.random(), true);
			req_start = Date.now();
			xhttp.send();
		}
		
</script>
</head>
<body onload="init(10)">
<pre id="demo">SERVER		CLIENT			DIFF

</pre>
<br/>
</body>
</html>